<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kap.service.dao.mp.MPBMemberPartsSocietyMapper">

    <select id="selectEduList" parameterType="MPBEduDto" resultType="MPBEduDto">
        select parnt_seq
             , prnt_cd_nm /*EBACouseMapper.selectEduList*/
             , ctgry_cd
             , ctgry_cd_nm
             , nm
             , stduy_mthd_cd
             , stduy_mthd_cd_nm
             , stduy_dd_cd
             , stduy_dd_cd_nm
             , stduy_time_cd
             , stduy_time_cd_nm
             , episd_year
             , episd_ord
             , accs_strt_dtm
             , accs_end_dtm
             , accs_status_nm
             , edctn_strt_dtm
             , edctn_end_dtm
             , edctn_status_nm
             , isttr_name
             , ffltn_nm
             , isttr_out_cnt
             , fxnum_cnt
             , acc_cnt
             , rcrmt_mthd_cd
             , rcrmt_mthd_cd_nm
             , pic_nm
             , pic_email
             , pic_tel_no
             , place_seq
             , place_nm
             , reg_id
             , reg_name
             , reg_dtm
             , mod_id
             , mod_name
             , exps_yn
             , cmpn_nm
             , ctgry_cd_cp_nm
             , size_cd_nm
             , work_bsnm_no
        from (select parnt_seq
                  , (select cd_nm from co_code_mst WHERE cd_seq = aa.parnt_seq) AS prnt_cd_nm
                  , ctgry_cd
                  , ctgry_cd_nm
                  , nm
                  , stduy_mthd_cd
                  , stduy_mthd_cd_nm
                  , stduy_dd_cd
                  , stduy_dd_cd_nm
                  , stduy_time_cd
                  , stduy_time_cd_nm
                  , episd_year
                  , episd_ord
                  , accs_strt_dtm
                  , accs_end_dtm
                  , case
                       when NOW() <![CDATA[<]]> accs_strt_dtm then '접수대기'
                       when NOW() <![CDATA[>]]> accs_strt_dtm AND NOW() <![CDATA[<]]>  accs_end_dtm then '접수중'
                       when NOW() <![CDATA[>]]> accs_end_dtm OR (fxnum_impsb_yn = 'N' AND 30 <![CDATA[>=]]> fxnum_cnt) then '마감'
                            END  AS accs_status_nm
                  , edctn_strt_dtm
                  , edctn_end_dtm
                  , case
                       when NOW() <![CDATA[<]]> edctn_strt_dtm then '교육대기'
                       when NOW() <![CDATA[>]]> edctn_strt_dtm AND NOW() <![CDATA[<]]> edctn_end_dtm then '교육중'
                       when NOW() <![CDATA[>]]> edctn_end_dtm then '교육마감'
                            END  AS edctn_status_nm
                  , (SELECT NAME FROM cp_isttr_mst WHERE isttr_seq = aa.min_isttr_seq) AS isttr_name
                  , (SELECT ffltn_nm FROM cp_isttr_mst WHERE isttr_seq = aa.min_isttr_seq) AS ffltn_nm
                  , case when isttr_cnt<![CDATA[<=]]> 1 then ''
                        when isttr_cnt  <![CDATA[>]]>   1 then isttr_cnt-1
                            END isttr_out_cnt
                  , fxnum_cnt
                  , 30 AS 'acc_cnt'
                  , rcrmt_mthd_cd
                  , rcrmt_mthd_cd_nm
                  , pic_nm
                  , pic_email
                  , pic_tel_no
                  , place_seq
                  , place_nm
                  , reg_id
                  , reg_name
                  , reg_dtm
                  , mod_id
                  , mod_name
                  , exps_yn
                  , cmpn_nm
                  , ctgry_cd_cp_nm
                  , size_cd_nm
                  , work_bsnm_no
               FROM (SELECT b.ctgry_cd
                          , (select cd_nm from co_code_mst WHERE cd = b.ctgry_cd) as ctgry_cd_nm
                          , (select parnt_seq from co_code_mst WHERE cd = b.ctgry_cd) as parnt_seq
                         , b.nm
                         , b.stduy_mthd_cd
                         , (select cd_nm from co_code_mst where cd=b.stduy_mthd_cd) as stduy_mthd_cd_nm
                         , b.stduy_dd_cd
                         , (select cd_nm from co_code_mst where cd=b.stduy_dd_cd) as stduy_dd_cd_nm
                         , b.stduy_time_cd
                         , (select cd_nm from co_code_mst where cd=b.stduy_time_cd) as stduy_time_cd_nm
                         , a.episd_year
                         , a.episd_ord
                         , a.accs_strt_dtm
                         , a.accs_end_dtm
                         , a.edctn_strt_dtm
                         , a.edctn_end_dtm
                         , (SELECT min(isttr_seq) FROM ed_edctn_isttr_rel c WHERE a.edctn_seq = c.edctn_seq AND a.episd_year = c.episd_year AND a.episd_ord = c.episd_ord) AS min_isttr_seq
                         , (SELECT COUNT(isttr_seq) FROM ed_edctn_isttr_rel c WHERE a.edctn_seq = c.edctn_seq AND a.episd_year = c.episd_year AND a.episd_ord = c.episd_ord) AS isttr_cnt
                         , a.fxnum_cnt
                         , a.fxnum_impsb_yn
                         , a.rcrmt_mthd_cd
                         , (select cd_nm from co_code_mst where cd=a.rcrmt_mthd_cd) as rcrmt_mthd_cd_nm
                         , a.pic_nm
                         , a.pic_email
                         , a.pic_tel_no
                         , a.place_seq
                         , (SELECT NM FROM ed_edctn_place_mst WHERE PLACE_SEQ = A.place_seq) as place_nm
                         , a.reg_id
                         , (select name from co_adm_mst where id = a.reg_id) as reg_name
                         , a.reg_dtm
                         , a.mod_id
                         , (select name from co_adm_mst where id = a.reg_id) as mod_name
                         , a.mod_dtm
                         , a.exps_yn
                         , cmpn_mst.cmpn_nm
                         , (select cd_nm from co_code_mst where  cd=cmpn_mst.ctgry_cd ) as ctgry_cd_cp_nm
                         , (select cd_nm from co_code_mst where  cd=cmpn_mst.size_cd  ) as size_cd_nm
                         , cmm.work_bsnm_no
                      FROM ed_edctn_episd_mst a
                       LEFT JOIN ed_edctn_prcs_mst b ON a.edctn_seq = b.edctn_seq
                       inner join ep_edctn_ptcpt_mst ptcpt_mst
                        on ptcpt_mst.edctn_seq = b.edctn_seq
                       inner join co_mem_mst cmm
                        on cmm.mem_seq = ptcpt_mst.mem_seq
                       inner join cp_cmpn_mst cmpn_mst
                        on cmm.work_bsnm_no  = cmpn_mst.bsnm_no
                          where ptcpt_mst.mem_seq=#{detailsKey} ) AA
                order by reg_dtm desc ) as cc
                 group by parnt_seq
                        , prnt_cd_nm
                        , ctgry_cd
                        , ctgry_cd_nm
                        , nm
                        , stduy_mthd_cd
                        , stduy_mthd_cd_nm
                        , stduy_dd_cd
                        , stduy_dd_cd_nm
                        , stduy_time_cd
                        , stduy_time_cd_nm
                        , episd_year
                        , episd_ord
                        , accs_strt_dtm
                        , accs_end_dtm
                        , accs_status_nm
                        , edctn_strt_dtm
                        , edctn_end_dtm
                        , edctn_status_nm
                        , isttr_name
                        , ffltn_nm
                        , isttr_out_cnt
                        , fxnum_cnt
                        , acc_cnt
                        , rcrmt_mthd_cd
                        , rcrmt_mthd_cd_nm
                        , pic_nm
                        , pic_email
                        , pic_tel_no
                        , place_seq
                        , place_nm
                        , reg_id
                        , reg_name
                        , reg_dtm
                        , mod_id
                        , mod_name
                        , exps_yn
                        , cmpn_nm
                        , ctgry_cd_cp_nm
                        , size_cd_nm
                        , work_bsnm_no
                     limit #{firstIndex}, #{recordCountPerPage}
    </select>

    <select id="selectEduListCnt" parameterType="MPBEduDto" resultType="java.lang.Integer">
       select count(*) /*EBACouseMapper.selectEduList*/
       from ( select parnt_seq
                   , prnt_cd_nm
                  , ctgry_cd
                  , ctgry_cd_nm
                  , nm
                  , stduy_mthd_cd
                  , stduy_mthd_cd_nm
                  , stduy_dd_cd
                  , stduy_dd_cd_nm
                  , stduy_time_cd
                  , stduy_time_cd_nm
                  , episd_year
                  , episd_ord
                  , accs_strt_dtm
                  , accs_end_dtm
                  , accs_status_nm
                  , edctn_strt_dtm
                  , edctn_end_dtm
                  , edctn_status_nm
                  , isttr_name
                  , ffltn_nm
                  , isttr_out_cnt
                  , fxnum_cnt
                  , acc_cnt
                  , rcrmt_mthd_cd
                  , rcrmt_mthd_cd_nm
                  , pic_nm
                  , pic_email
                  , pic_tel_no
                  , place_seq
                  , place_nm
                  , reg_id
                  , reg_name
                  , reg_dtm
                  , mod_id
                  , mod_name
                  , exps_yn
                  , cmpn_nm
                  , ctgry_cd_cp_nm
                  , size_cd_nm
                  , work_bsnm_no
              from (select parnt_seq
                         , (select cd_nm from co_code_mst WHERE cd_seq = aa.parnt_seq) AS prnt_cd_nm
                         , ctgry_cd
                         , ctgry_cd_nm
                         , nm
                         , stduy_mthd_cd
                         , stduy_mthd_cd_nm
                         , stduy_dd_cd
                         , stduy_dd_cd_nm
                         , stduy_time_cd
                         , stduy_time_cd_nm
                         , episd_year
                         , episd_ord
                         , accs_strt_dtm
                         , accs_end_dtm
                         , case
                               when NOW() <![CDATA[<]]> accs_strt_dtm then '접수대기'
                               when NOW() <![CDATA[>]]> accs_strt_dtm AND NOW() <![CDATA[<]]>  accs_end_dtm then '접수중'
                               when NOW() <![CDATA[>]]> accs_end_dtm OR (fxnum_impsb_yn = 'N' AND 30 <![CDATA[>=]]> fxnum_cnt) then '마감'
                                    END  AS accs_status_nm
                         , edctn_strt_dtm
                         , edctn_end_dtm
                         , case
                               when NOW() <![CDATA[<]]> edctn_strt_dtm then '교육대기'
                               when NOW() <![CDATA[>]]> edctn_strt_dtm AND NOW() <![CDATA[<]]> edctn_end_dtm then '교육중'
                               when NOW() <![CDATA[>]]> edctn_end_dtm then '교육마감'
                                    END  AS edctn_status_nm
                         , (SELECT NAME FROM cp_isttr_mst WHERE isttr_seq = aa.min_isttr_seq) AS isttr_name
                         , (SELECT ffltn_nm FROM cp_isttr_mst WHERE isttr_seq = aa.min_isttr_seq) AS ffltn_nm
                         , case when isttr_cnt<![CDATA[<=]]> 1 then ''
                                when isttr_cnt  <![CDATA[>]]>   1 then isttr_cnt-1
                                    END isttr_out_cnt
                         , fxnum_cnt
                         , 30 AS 'acc_cnt'
                         , rcrmt_mthd_cd
                         , rcrmt_mthd_cd_nm
                         , pic_nm
                         , pic_email
                         , pic_tel_no
                         , place_seq
                         , place_nm
                         , reg_id
                         , reg_name
                         , reg_dtm
                         , mod_id
                         , mod_name
                         , exps_yn
                         , cmpn_nm
                         , ctgry_cd_cp_nm
                         , size_cd_nm
                         , work_bsnm_no
                     FROM (SELECT b.ctgry_cd
                                , (select cd_nm from co_code_mst WHERE cd = b.ctgry_cd) as ctgry_cd_nm
                                , (select parnt_seq from co_code_mst WHERE cd = b.ctgry_cd) as parnt_seq
                                , b.nm
                                , b.stduy_mthd_cd
                                , (select cd_nm from co_code_mst where cd=b.stduy_mthd_cd) as stduy_mthd_cd_nm
                                , b.stduy_dd_cd
                                , (select cd_nm from co_code_mst where cd=b.stduy_dd_cd) as stduy_dd_cd_nm
                                , b.stduy_time_cd
                                , (select cd_nm from co_code_mst where cd=b.stduy_time_cd) as stduy_time_cd_nm
                                , a.episd_year
                                , a.episd_ord
                                , a.accs_strt_dtm
                                , a.accs_end_dtm
                                , a.edctn_strt_dtm
                                , a.edctn_end_dtm
                                , (SELECT min(isttr_seq) FROM ed_edctn_isttr_rel c WHERE a.edctn_seq = c.edctn_seq AND a.episd_year = c.episd_year AND a.episd_ord = c.episd_ord) AS min_isttr_seq
                                , (SELECT COUNT(isttr_seq) FROM ed_edctn_isttr_rel c WHERE a.edctn_seq = c.edctn_seq AND a.episd_year = c.episd_year AND a.episd_ord = c.episd_ord) AS isttr_cnt
                                , a.fxnum_cnt
                                , a.fxnum_impsb_yn
                                , a.rcrmt_mthd_cd
                                , (select cd_nm from co_code_mst where cd=a.rcrmt_mthd_cd) as rcrmt_mthd_cd_nm
                                , a.pic_nm
                                , a.pic_email
                                , a.pic_tel_no
                                , a.place_seq
                                , (SELECT NM FROM ed_edctn_place_mst WHERE PLACE_SEQ = A.place_seq) as place_nm
                                , a.reg_id
                                , (select name from co_adm_mst where id = a.reg_id) as reg_name
                                , a.reg_dtm
                                , a.mod_id
                                , (select name from co_adm_mst where id = a.reg_id) as mod_name
                                , a.mod_dtm
                                , a.exps_yn
                                , cmpn_mst.cmpn_nm
                                , (select cd_nm from co_code_mst where  cd=cmpn_mst.ctgry_cd ) as ctgry_cd_cp_nm
                                , (select cd_nm from co_code_mst where  cd=cmpn_mst.size_cd  ) as size_cd_nm
                                , cmm.work_bsnm_no
                       FROM ed_edctn_episd_mst a
                        LEFT JOIN ed_edctn_prcs_mst b ON a.edctn_seq = b.edctn_seq
                        inner join ep_edctn_ptcpt_mst ptcpt_mst
                          on ptcpt_mst.edctn_seq = b.edctn_seq
                        inner join co_mem_mst cmm
                          on cmm.mem_seq = ptcpt_mst.mem_seq
                        inner join cp_cmpn_mst cmpn_mst
                          on cmm.work_bsnm_no  = cmpn_mst.bsnm_no
                      where ptcpt_mst.mem_seq=#{detailsKey} ) AA
                        order by reg_dtm desc ) as cc
                        group by parnt_seq
                               , prnt_cd_nm
                               , ctgry_cd
                               , ctgry_cd_nm
                               , nm
                               , stduy_mthd_cd
                               , stduy_mthd_cd_nm
                               , stduy_dd_cd
                               , stduy_dd_cd_nm
                               , stduy_time_cd
                               , stduy_time_cd_nm
                               , episd_year
                               , episd_ord
                               , accs_strt_dtm
                               , accs_end_dtm
                               , accs_status_nm
                               , edctn_strt_dtm
                               , edctn_end_dtm
                               , edctn_status_nm
                               , isttr_name
                               , ffltn_nm
                               , isttr_out_cnt
                               , fxnum_cnt
                               , acc_cnt
                               , rcrmt_mthd_cd
                               , rcrmt_mthd_cd_nm
                               , pic_nm
                               , pic_email
                               , pic_tel_no
                               , place_seq
                               , place_nm
                               , reg_id
                               , reg_name
                               , reg_dtm
                               , mod_id
                               , mod_name
                               , exps_yn
                               , cmpn_nm
                               , ctgry_cd_cp_nm
                               , size_cd_nm
                               , work_bsnm_no ) as ccc

    </select>

</mapper>