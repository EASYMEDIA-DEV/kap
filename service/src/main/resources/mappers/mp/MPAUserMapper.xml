<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kap.service.dao.mp.MPAUserMapper">
    <!--
        쿼리명 : MPAUserMapper.selectUserList
        설  명 : 일반 사용자 목록을 조회한다.
          수정일      수정자       수정내용
        ==========   ========   ==============
        2023.11.09    양현우       최초생성
    -->
    <select id="selectUserList" parameterType="MPAUserDto" resultType="MPAUserDto">
        select mem_seq
             , id
             , name
             , hp_no
             , email
             , reg_dtm
             , mod_dtm
             , mem_cd
             , mod_name
          from ( select mem.mem_seq
                      , mem.id
                      , mem.name
                      , mem.hp_no
                      , mem.email
                      , mem.reg_dtm
                      , mem.mod_dtm
                      , mem.mem_cd
                      , case when mst.mod_cd ='AD' then (select name from co_adm_mst where id=mst.reg_id)
                             when mst.mod_cd = 'CO' then (select name FROM co_mem_mst where id=mst.reg_id)
                                else null end as mod_name
                  from co_mem_mst mem
                    inner join ( select mem_mod_seq
                                      , mem_seq
                                      , mod_cd
                                      , reg_id
                                    from co_mem_mod_log
                                      where ( mem_mod_seq
                                            , mem_seq)
                                        in ( select max(mem_mod_seq)
                                                  , mem_seq
                                               from co_mem_mod_log
                                                 group by mem_seq
                                           )
                                  ) mst
                     on mem.mem_seq = mst.mem_seq ) as ma
                <include refid="selectUserListWhereSql" />
                        order by
                            ma.reg_dtm desc
                <if test="excelYn != 'Y'.toString() ">
                            limit   #{firstIndex}, #{recordCountPerPage}
                </if>
    </select>

    <select id="selectUserListCnt" parameterType="MPAUserDto" resultType="java.lang.Integer">
        select count(*)
          from ( select mem.mem_seq
                      , mem.id
                      , mem.name
                      , mem.hp_no
                      , mem.email
                      , mem.reg_dtm
                      , mem.mod_dtm
                      , mem.mem_cd
                      , case when mst.mod_cd ='AD' then (select name from co_adm_mst where id=mst.reg_id)
                             when mst.mod_cd = 'CO' then (select name FROM co_mem_mst where id=mst.reg_id)
                            else null end as mod_name
                    from co_mem_mst mem
                        inner join ( select mem_mod_seq
                                          , mem_seq
                                          , mod_cd
                                          , reg_id
                                       from co_mem_mod_log
                                        where ( mem_mod_seq
                                               , mem_seq)
                                         in ( select max(mem_mod_seq)
                                                   , mem_seq
                                               from co_mem_mod_log
                                                group by mem_seq )
                                    ) mst
                            on mem.mem_seq = mst.mem_seq ) as ma
        <include refid="selectUserListWhereSql" />
	</select>

    <!--
       쿼리명 : selectUserListWhereSql
       설  명 : 일반사용자 목록 검색 조건 SQL
         수정일      수정자       수정내용
       ==========   ========   ==============
       2023.11.09   양현우       최초생성
   -->
    <sql id="selectUserListWhereSql">
        <where>
                and ma.mem_cd = #{memCd}
            <if test="date == 1">
                <if test="strtDt != null and strtDt != ''.toString() ">
                    and ma.reg_dtm <![CDATA[>=]]> str_to_date(#{strtDt}, '%Y-%m-%d')
                </if>
                <if test="endDt != null and endDt != ''.toString() ">
                    and ma.reg_dtm <![CDATA[<]]> date_add(str_to_date(#{endDt}, '%Y-%m-%d'), interval 1 day)
                </if>
            </if>
            <if test="date == 2">
                <if test="strtDt != null and strtDt != ''.toString() ">
                    and ma.mod_dtm <![CDATA[>=]]> str_to_date(#{strtDt}, '%Y-%m-%d')
                </if>
                <if test="endDt != null and endDt != ''.toString() ">
                    and ma.mod_dtm <![CDATA[<]]> date_add(str_to_date(#{endDt}, '%Y-%m-%d'), interval 1 day)
                </if>
            </if>

            <if test="q != null and q != ''.toString() ">
                <choose>
                    <when test="f == 1">
                        and ma.id like concat('%', #{q}, '%')
                    </when>
                    <when test="f == 2">
                        and ma.name like concat('%', #{q}, '%')
                    </when>
                    <when test="f == 3">
                        and ma.hp_no like concat('%', #{q}, '%')
                    </when>
                    <when test="f == 4">
                        and ma.email like concat('%', #{q}, '%')
                    </when>
                    <when test="f == 5">
                        and (ma.mod_name like concat('%', #{q}, '%') )
                    </when>
                    <otherwise>
                        and
                        (
                        ma.id like concat('%', #{q}, '%')
                        or
                        ma.name like concat('%', #{q}, '%')
                        or
                        ma.hp_no like concat('%', #{q}, '%')
                        or
                        ma.email like concat('%', #{q}, '%')
                        or
                        ma.mod_name like concat('%', #{q}, '%')
                        )
                    </otherwise>
                </choose>
            </if>
        </where>
    </sql>


    <!--
      쿼리명 : MPAUserMapper.selectUserDtl
      설  명 : 일반 사용자 상세을 조회한다.
        수정일      수정자       수정내용
      ==========   ========   ==============
      2023.11.09    양현우       최초생성
  -->
    <select id="selectUserDtl" parameterType="MPAUserDto" resultType="MPAUserDto">
        select mem.mem_seq
             , mem.id
             , mem.name
             , mem.hp_no
             , mem.email
             , mem.reg_dtm
             , mem.mod_dtm
             , mem.last_lgn_dtm
             , mem.mem_cd
             , case when mst.mod_cd ='AD' then (select name from co_adm_mst where id=mst.reg_id)
                    when mst.mod_cd = 'CO' then (select name FROM co_mem_mst where id=mst.reg_id)
                    else null end as mod_name
                from co_mem_mst mem
                    inner join ( select mem_mod_seq
                                           , mem_seq
                                           , mod_cd
                                           , reg_id
                                      from co_mem_mod_log
                                      where ( mem_mod_seq
                                                , mem_seq)
                                                in ( select max(mem_mod_seq)
                                                          , mem_seq
                                                     from co_mem_mod_log
                                                     group by mem_seq )
                    ) mst
                        on mem.mem_seq = mst.mem_seq
                where mem.mem_seq = #{detailsKey}
    </select>

    <!--
        쿼리명 : MPAUserMapper.selectUserDtl
        설  명 : 일반 사용자 상세을 조회한다.
          수정일      수정자       수정내용
        ==========   ========   ==============
        2023.11.10    양현우       최초생성
    -->
    <select id="selectUserDtlTab" parameterType="MPAUserDto" resultType="MPAUserDto">
            select mem.mem_seq
                 , mem.id
                 , mem.name
                 , mem.zipcode
                 , mem.bsc_addr
                 , mem.dtl_addr
                 , mem.tel_no
                 , mem.hp_no
                 , mem.email
                 , mem.birth
                 , mem.gndr
                 , mem.mod_dtm
                 , mem.ntfy_sms_rcv_chng_dtm
                 , mem.ntfy_sms_rcv_yn
                 , mem.ntfy_email_rcv_chng_dtm
                 , mem.ntfy_email_rcv_yn
                 , mem.mem_cd
                 , case when mst.mod_cd ='AD' then (select name from co_adm_mst where id=mst.reg_id)
                        when mst.mod_cd = 'CO' then (select name FROM co_mem_mst where id=mst.reg_id)
                        else null end as mod_name
            from co_mem_mst mem
                     inner join ( select mem_mod_seq
                                       , mem_seq
                                       , mod_cd
                                       , reg_id
                                  from co_mem_mod_log
                                  where ( mem_mod_seq
                                            , mem_seq)
                                            in ( select max(mem_mod_seq)
                                                      , mem_seq
                                                 from co_mem_mod_log
                                                 group by mem_seq )
                                ) mst
                        on mem.mem_seq = mst.mem_seq
                 where mem.mem_seq = #{detailsKey}
    </select>

    <!--
    쿼리명 : MPAUserMapper.selectDupEmail
    설  명 : 이메일 중복 검사
      수정일      수정자       수정내용
    ==========   ========   ==============
    2023.11.10    양현우       최초생성
-->
    <select id="selectDupEmail" parameterType="MPAUserDto" resultType="java.lang.Integer">
        select count(*)
            from co_mem_mst
              where mem_seq not in(#{detailsKey})
               and email=#{email}
    </select>


    <!--
    쿼리명 : MPAUserMapper.updateUserDtl
    설  명 : 사용자  수정
      수정일      수정자       수정내용
    ==========   ========   ==============
    2023.11.10    양현우       최초생성
-->
    <update id="updateUserDtl" parameterType="MPAUserDto">
        update co_mem_mst
            set zipcode =#{zipcode}
              , bsc_addr =#{bscAddr}
              , dtl_addr =#{dtlAddr}
              , tel_no =#{telNo}
              , email =#{email}
              , ntfy_sms_rcv_yn=#{ntfySmsRcvYn}
              , ntfy_email_rcv_yn =#{ntfyEmailRcvYn}
              , mod_id =#{regId}
              , mod_ip =#{regIp}
              , mod_dtm = now()
            where id =#{id}
    </update>

    <select id="selectSeqNum" parameterType="MPAUserDto" resultType="java.lang.String">
        SELECT /* SMDAPsnIfMapper.selectSeqNum */
            NEXT_ID
        FROM CO_SEQ_MST
        WHERE TABLE_NM = #{tableNm}
    </select>

    <!--
        쿼리명 : insertUserDtlHistory.insertUserDtlHistory
        설  명 : 사용자 수정  이력
          수정일      수정자       수정내용
        ==========   ========   ==============
        2023.11.10    양현우       최초생성
        -->
    <insert id="insertUserDtlHistory" parameterType="MPAUserDto">
        insert into co_mem_mod_log
                ( mem_mod_seq
                , mem_seq
                , mod_cd
                , bfre_zipcode
                , bfre_bsc_addr
                , bfre_dtl_addr
                , bfre_email
                , bfre_dept_cd
                , bfre_pstn_cd
                , bfre_tel_no
                , bfre_bsnm_reg_no
                , bfre_sms_rcv_yn
                , bfre_email_rcv_yn
                , reg_ip
                , reg_dtm
                , reg_id
                 )
                select #{modSeq}
                      , mem_seq
                      , #{modCd}
                      , zipcode
                      , bsc_addr
                      , dtl_addr
                      , email
                      , dept_cd
                      , pstn_cd
                      , tel_no
                      , bsnm_no
                      , ntfy_sms_rcv_yn
                      , ntfy_email_rcv_yn
                      , #{regIp}
                      , now()
                      , #{regId}
                   from co_mem_mst
                    where id =#{id}
    </insert>


    <!--
    쿼리명 : MPAUserMapper.selectAttcntList
    설  명 : 일반 사용자 미래차공모전 리스트 조회 (코드 따서 select 추가 해야 됨)
      수정일      수정자       수정내용
    ==========   ========   ==============
    2023.11.13    양현우       최초생성
-->
    <select id="selectAttcntList" parameterType="MPAAttctnDto" resultType="MPAAttctnDto">
        select appctn_mst.mem_seq
             , appctn_mst.reg_dtm
             , episd_mst.year
             , episd_mst.episd
             , rsume_dtl.appctn_stts_cd
             , rsume_dtl.mng_stts_cd
             , car_dtl.ctgry_cd
             , car_dtl.name
             , car_dtl.wdcrm_cd
             , case when (select count(*)
                          from cx_appctn_rsume_prize_car_tmmbr_dtl
                          where rsume_seq = rsume_dtl.rsume_seq
                            and rsume_ord = rsume_dtl.rsume_ord ) >0 then '팀'
                    else '개인' end as participation_category
           from cx_appctn_mst appctn_mst
            inner join cx_episd_mst episd_mst
             on appctn_mst.episd_seq = episd_mst.episd_seq
            inner join cx_appctn_rsume_dtl rsume_dtl
             on appctn_mst.appctn_seq =rsume_dtl.appctn_seq
            inner join cx_appctn_rsume_prize_car_dtl car_dtl
             on rsume_dtl.rsume_seq = car_dtl.rsume_seq
              and rsume_dtl.rsume_ord = car_dtl.rsume_ord
               where appctn_mst.mem_seq=#{detailsKey}
                   order by appctn_mst.appctn_seq desc
                limit   #{firstIndex}, #{recordCountPerPage}
    </select>

    <!--
쿼리명 : MPAUserMapper.selectAttcntList
설  명 : 일반 사용자 미래차공모전 갯수 조회
  수정일      수정자       수정내용
==========   ========   ==============
2023.11.13    양현우       최초생성
-->
    <select id="selectAttcntListCnt" parameterType="MPAAttctnDto" resultType="java.lang.Integer">
        select count(*)
        from cx_appctn_mst appctn_mst
                 inner join cx_episd_mst episd_mst
                            on appctn_mst.episd_seq = episd_mst.episd_seq
                 inner join cx_appctn_rsume_dtl rsume_dtl
                            on appctn_mst.appctn_seq =rsume_dtl.appctn_seq
                 inner join cx_appctn_rsume_prize_car_dtl car_dtl
                            on rsume_dtl.rsume_seq = car_dtl.rsume_seq
                                and rsume_dtl.rsume_ord = car_dtl.rsume_ord
        where appctn_mst.mem_seq=#{detailsKey}
    </select>

    <!--
쿼리명 : MPAUserMapper.selectInqrList
설  명 : 문의 내용 리스트 조회
  수정일      수정자       수정내용
==========   ========   ==============
2023.11.13    양현우       최초생성
-->
    <select id="selectInqrList" parameterType="MPAInqrDto" resultType="MPAInqrDto">
        select inqr_mst.titl
             , inqr_mst.reg_dtm as start_inqr_dtm
             , rply_dtl.reg_dtm as end_inqr_dtm
             , case when inqr_mst.init_chk_dtm is null then '접수대기'
                    when inqr_mst.init_chk_dtm is not null and rply_dtl.cntn is null then '접수완료'
                    when inqr_mst.init_chk_dtm is not null and rply_dtl.cntn is not null then '답변완료'
                    else null end as inqr_stts
            from co_mem_inqr_mst inqr_mst
             left outer join co_mem_inqr_rply_dtl rply_dtl
              on inqr_mst.inqr_seq  = rply_dtl.inqr_seq
                where mem_seq =#{detailsKey}
                 order by inqr_mst.inqr_seq desc
                  limit   #{firstIndex}, #{recordCountPerPage}
    </select>

    <!--
쿼리명 : MPAUserMapper.selectAttcntList
설  명 : 문의 내용 리스트 조회
  수정일      수정자       수정내용
==========   ========   ==============
2023.11.13    양현우       최초생성
-->
    <select id="selectInqrListCnt" parameterType="MPAInqrDto" resultType="java.lang.Integer">
        select count(*)
        from co_mem_inqr_mst inqr_mst
         left outer join co_mem_inqr_rply_dtl rply_dtl
          on inqr_mst.inqr_seq  = rply_dtl.inqr_seq
           where inqr_mst.mem_seq=#{detailsKey}
    </select>

</mapper>