<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kap.service.dao.ex.exg.EXGExamMapper">
	<!--
		쿼리명 : EXGExamMapper.selectExamList
		설  명 : 목록 조회
	      수정일      수정자       수정내용
        ==========   ========   ==============
        2023.11.09    김학규       최초생성
    -->
	<select id="selectExamList" parameterType="EXGExamMstDTO" resultType="EXGExamMstDTO">
		select /* EXGExamMapper.selectExamList */
		      exam_seq
			, titl
			, exps_yn
			, reg_id
		    , (select name from co_adm_mst where id = a.reg_id ) reg_name
			, reg_dtm
			, mod_id
			, (select name from co_adm_mst where id = a.mod_id ) mod_name
			, mod_dtm
		from
			ex_exam_mst a
		<include refid="selectExamListWhereSql" />
		order by
			reg_dtm desc
		limit #{firstIndex}, #{recordCountPerPage}
	</select>
	<!--
		쿼리명 : EXGExamMapper.getExamListCnt
		설  명 : 목록 전체 갯수
	      수정일      수정자       수정내용
        ==========   ========   ==============
        2023.11.09    김학규       최초생성
    -->
	<select id="getExamListCnt" parameterType="EXGExamMstDTO" resultType="java.lang.Integer">
		select /* EXGExamMapper.getAdmListCnt */
			count(*)
		from
			ex_exam_mst a
		<include refid="selectExamListWhereSql" />
	</select>
	<!--
		쿼리명 : selectExamListWhereSql
		설  명 : 목록 조건
	      수정일      수정자       수정내용
        ==========   ========   ==============
        2019.07.08    김학규       최초생성
    -->
	<sql id="selectExamListWhereSql">
		<where>
			<if test="strtDt != null and strtDt != ''.toString() ">
				<choose>
					<when test="srchDate == 1">
						AND reg_dtm <![CDATA[ > ]]> str_to_date(#{strtDt}, '%Y-%m-%d')
					</when>
					<when test="srchDate == 2">
						AND mod_dtm <![CDATA[ > ]]> str_to_date(#{strtDt}, '%Y-%m-%d')
					</when>
				</choose>
			</if>
			<if test="endDt != null and endDt != ''.toString() ">
				<choose>
					<when test="srchDate == 1">
						AND reg_dtm <![CDATA[ < ]]> date_add(str_to_date(#{endDt}, '%Y-%m-%d'), interval 1 day)
					</when>
					<when test="srchDate == 2">
						AND mod_dtm <![CDATA[ < ]]> date_add(str_to_date(#{endDt}, '%Y-%m-%d'), interval 1 day)
					</when>
				</choose>
			</if>
			<if test="expsYnList != null and expsYnList.size() > 0">
				and
				<foreach collection="expsYnList" item="expsYnList" index="index" open="(" close=")" separator=" or ">
					exps_yn = #{expsYnList}
				</foreach>
			</if>
			<if test="q != null and q != ''.toString() ">
				<choose>
					<when test="f == 1">
						and titl like concat('%', #{q}, '%')
					</when>
					<when test="f == 2">
						and name like concat('%', #{q}, '%')
					</when>
					<when test="f == 3 ">
						and exists(select id from co_adm_mst where id = a.reg_id and (name like concat('%', #{q}, '%') or id like concat('%', #{q}, '%')))
					</when>
					<when test="f == 4 ">
						and exists(select id from co_adm_mst where id = a.mod_id and (name like concat('%', #{q}, '%') or id like concat('%', #{q}, '%')))
					</when>
					<otherwise>
						and (
							titl like concat('%', #{q}, '%')
							or exists(select id from co_adm_mst where id = a.reg_id and (name like concat('%', #{q}, '%') or id like concat('%', #{q}, '%')))
							or exists(select id from co_adm_mst where id = a.mod_id and (name like concat('%', #{q}, '%') or id like concat('%', #{q}, '%')))
						)
					</otherwise>
				</choose>
			</if>
		</where>
	</sql>
	<!--
         쿼리명 : EXGExamMapper.deleteExamList
         설  명 : 목록 삭제
          수정일     수정자       수정내용
        ==========   ======    ==============
        2023.11.10   김학규       최초생성
    -->
	<delete id="deleteExamList" parameterType="EXGExamMstDTO">
		delete /* COAAdmMapper.deleteExamList */
		from
		ex_exam_mst
		<where>
			<choose>
				<when test="delValueList != null and delValueList.size() > 0">
					exam_seq in
					<foreach collection="delValueList" item="delValueList" index="index" separator=", " open="(" close=")">
						#{delValueList}
					</foreach>
				</when>
				<otherwise>
					exam_seq = #{detailsKey}
				</otherwise>
			</choose>
		</where>
	</delete>

	<!--
		쿼리명 : EXGExamMapper.getExamEdctnEpisdCnt
		설  명 : 평가지 교육 매핑 여부
	      수정일      수정자       수정내용
        ==========   ========   ==============
        2023.11.09    김학규       최초생성
    -->
	<select id="getExamEdctnEpisdCnt" parameterType="EXGExamMstDTO" resultType="java.lang.Integer">
		select /* EXGExamMapper.getExamEdctnEpisdCnt */
			count(*) recp_cnt
		from ex_exam_mst exam_mst join ed_edctn_episd_mst episd_mst
		on episd_mst.exam_seq = exam_mst.exam_seq
		<where>
			<choose>
				<when test="delValueList != null and delValueList.size() > 0">
					exam_mst.exam_seq in
					<foreach collection="delValueList" item="delValueList" index="index" separator=", " open="(" close=")">
						#{delValueList}
					</foreach>
				</when>
				<otherwise>
					exam_mst.exam_seq = #{detailsKey}
				</otherwise>
			</choose>
		</where>
	</select>

	<!--
         쿼리명 : EXGExamMapper.insertExamMst
         설  명 : 교육 시험 마스터 등록
          수정일     수정자       수정내용
        ==========   ======    ==============
        2023.11.09    김학규       최초생성
    -->
	<insert id="insertExamMst" parameterType="EXGExamMstInsertDTO">
		insert /* EXGExamMapper.insertExamMst */ into ex_exam_mst
		(
			  exam_seq
			, titl
			, smmry_cntn
			, exps_yn
			, reg_id
			, reg_ip
			, reg_dtm
			, mod_id
			, mod_ip
			, mod_dtm
		)
		values
			(
			  #{detailsKey}
			, #{titl}
			, #{smmryCntn}
			, #{expsYn}
			, #{regId}
			, #{regIp}
			, now()
			, #{regId}
			, #{regIp}
			, now()
			)
	</insert>

</mapper>


